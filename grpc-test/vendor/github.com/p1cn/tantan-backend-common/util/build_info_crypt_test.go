package util

import (
	"testing"
	"time"
)

func TestBuildInfoDecryptShortInput(t *testing.T) {
	bs := "12345678901234567"
	secret := "12345678901234567890123456789012"

	_, err := BuildInfoDecrypt([]byte(bs), secret)
	if err == nil {
		t.Errorf("Content should generate failed decrypt error")
	}
}

func TestBuildInfoEncrypt(t *testing.T) {
	build_info_str := `{"ro.product.manufacturer":"HUAWEI","gsm.sim.operator.alpha":",","ro.debuggable":"0","persist.sys.usb.config":"mtp,adb","init.svc.netmgrd":"running","init.svc.debuggerd":"running","persist.radio.eons.enabled":"false","persist.sys.profiler_ms":"0","init.svc.ueventd":"running","persist.radio.custom_ecc":"1","ro.product.model":"H30-C00","ro.boot.emmc":"true","ro.build.fingerprint":"Huawei/H30-C00/hwH30-C00:4.3/HuaweiH30-C00/C92B184:user/ota-rel-keys,release-keys","service.bootanim.exit":"1","ro.build.product":"H30-C00","init.svc.irsc_util":"stopped","ro.bootloader":"unknown","init.svc.vold":"running",".libc.so.e_machine":"false","init.svc.mpdecision":"running","ro.boot.serialno":"8239868a","sys.settings_global_version":"6","net.hostname":"android-997d50646e34835a","keyguard.no_require_sim":"true","init.svc.p2p_supplicant":"running","ro.build.version.sdk":"18","net.bt.name":"Android","telephony.lteOnCdmaDevice":"0","sys.usb.config":"mtp,adb","init.svc.time_daemon":"running","ro.bootmode":"unknown","ro.baseband":"msm","ro.runtime.firstboot":"1464317954203","ro.build.host":"huawei-desktop","init.svc.thermal-engine":"running","ro.build.display.id":"H30-C00V100R001C92B184","ril.ecclist":"911,112,000,08,110,999,118,119,120,122","persist.service.bdroid.bdaddr":"22:22:be:94:5f:ef","persist.radio.data_no_toggle":"1","ro.revision":"0","wifi.interface":"wlan0","gsm.operator.isroaming":"false,false","persist.sys.timezone":"Asia/Shanghai","gsm.operator.numeric":"null,null","ro.telephony.default_network":"4","ro.allow.mock.location":"0","ro.crypto.state":"unsupported","ro.boot.baseband":"msm","dalvik.vm.heapstartsize":"5m","gsm.version.baseband":"203015,203015","dalvik.vm.heapminfree":"2m","ro.product.brand":"Huawei","gsm.sim.operator.numeric":",","ro.config.notification_sound":"notification.ogg","ro.build.date.utc":"1416427365","ro.board.platform":"msm8610","dalvik.vm.heaptargetutilization":"0.75","ro.product.device":"hwH30-C00","ro.ril.svdo":"false","dev.bootcomplete":"1","gsm.sim.state":"ABSENT,ABSENT",".Debug.isDebuggerConnected":"false","init.svc.keystore":"running","ro.hardware":"qcom","init.svc.netd":"running","ro.build.characteristics":"default","ro.build.id":"HuaweiH30-C00","init.svc.qmuxd":"running","init.svc.qcamerasvr":"running","sys.usb.state":"mtp,adb","ro.adb.secure":"1","rild.libpath":"/vendor/lib/libril-qc-qmi-1.so","sys.boot_completed":"1","ro.product.name":"H30-C00","net.change":"net.dns3","ro.config.alarm_alert":"alarm.ogg","ro.build.tags":"release-keys","gsm.version.ril-impl":"Qualcomm RIL 1.0","ro.product.board":"H30-C00","init.svc.drm":"running","ro.build.description":"H30-C00-user 4.3 GRJ90 C92B184 release-keys","init.svc.media":"running","ro.build.version.codename":"REL","ro.product.cpu.abi":"armeabi-v7a","dalvik.vm.heapgrowthlimit":"96m","ro.sf.lcd_density":"320","init.svc.bootanim":"stopped","dalvik.vm.heapsize":"256m","dalvik.vm.stack-trace-file":"/data/anr/traces.txt","ro.com.google.clientidbase":"android-huawei","init.svc.surfaceflinger":"running","ro.serialno":"f49ff391c6c0","dalvik.vm.heapmaxfree":"8m","ro.build.date":"Thu Nov 20 04:02:45 CST 2014","ro.com.android.dataroaming":"false","init.svc.flash_recovery":"stopped","ro.build.version.release":"4.3","vold.post_fs_data_done":"1","wlan.driver.status":"ok","ro.product.cpu.abi2":"armeabi","drm.service.enabled":"true","media.aac_51_output_enabled":"true","init.svc.zygote":"running","ro.telephony.call_ring.multiple":"false","init.svc.servicemanager":"running","gsm.current.phone-type":"1,1","ro.build.user":"huawei","ro.opengles.version":"196608","gsm.sim.operator.iso-country":",","ro.config.ringtone":"ringtone.ogg","ro.boot.hardware":"qcom","ro.ril.svlte1x":"false","init.svc.installd":"running","init.svc.qseecomd":"running","ro.secure":"1","ro.carrier":"unknown","ro.build.type":"user","ro.build.version.incremental":"C92B184","init.svc.adbd":"running","net.qtaguid_enabled":"1","net.dns3":"114.114.115.115","gsm.operator.alpha":"null,null","gsm.network.type":"Unknown,Unknown","net.dns2":"114.114.114.114","net.dns1":"202.106.196.115","init.svc.rmt_storage":"running","init.svc.ril-daemon":"running"}`
	secret := "2gr!4Yu$JW7pyMfXJXLQcdGcP7JZ7G8*&e+@w%!*TzNBZRX2jX"

	_, err := BuildInfoEncrypt(build_info_str, secret)
	if err != nil {
		t.Errorf("%s", "unable to process encryption")
		t.FailNow()
	}
}

func TestBuildInfoDecrypt(t *testing.T) {
	build_info_arr := []byte{60, 133, 152, 11, 33, 230, 160, 152, 193, 217, 221, 1, 195, 49, 173, 223, 61, 103, 154, 32, 31, 26, 162, 198, 6, 142, 211, 169, 174, 73, 106, 63, 1, 112, 219, 179, 223, 185, 18, 140, 168, 14, 174, 144, 181, 50, 209, 85, 217, 40, 209, 117, 37, 119, 54, 158, 253, 235, 255, 76, 59, 244, 53, 103, 175, 170, 191, 100, 199, 82, 116, 1, 184, 54, 21, 254, 188, 205, 108, 201, 62, 19, 67, 8, 50, 65, 133, 127, 0, 89, 125, 122, 83, 163, 204, 56, 145, 177, 160, 85, 99, 207, 164, 169, 45, 238, 178, 252, 78, 136, 196, 155, 105, 202, 68, 198, 64, 49, 94, 214, 13, 95, 67, 99, 252, 195, 121, 235, 16, 151, 128, 219, 7, 154, 114, 43, 189, 136, 93, 103, 224, 12, 171, 7, 246, 110, 197, 72, 195, 194, 19, 111, 132, 67, 236, 166, 94, 244, 227, 30, 99, 80, 24, 150, 211, 23, 19, 77, 245, 233, 98, 36, 3, 184, 179, 181, 249, 227, 172, 8, 117, 103, 147, 202, 86, 102, 74, 66, 193, 55, 10, 3, 43, 123, 228, 58, 140, 147, 51, 10, 166, 76, 246, 99, 229, 105, 27, 100, 111, 78, 140, 255, 39, 27, 150, 70, 123, 201, 65, 166, 7, 139, 4, 119, 243, 246, 208, 40, 220, 224, 160, 101, 254, 24, 120, 148, 72, 247, 45, 23, 42, 103, 78, 27, 202, 79, 91, 174, 44, 237, 34, 179, 42, 116, 253, 138, 206, 117, 54, 250, 82, 101, 200, 165, 220, 165, 34, 77, 149, 162, 29, 177, 34, 14, 209, 100, 112, 111, 13, 158, 147, 199, 226, 11, 125, 210, 145, 169, 66, 144, 217, 180, 133, 14, 107, 56, 172, 252, 144, 255, 85, 72, 241, 129, 164, 137, 32, 90, 45, 194, 128, 222, 109, 242, 22, 200, 28, 75, 115, 35, 102, 48, 131, 142, 223, 139, 251, 129, 163, 40, 93, 161, 13, 231, 187, 209, 164, 167, 61, 34, 82, 176, 136, 176, 62, 190, 201, 75, 45, 10, 141, 155, 216, 76, 229, 39, 3, 52, 93, 145, 211, 132, 138, 236, 50, 248, 146, 1, 117, 208, 236, 117, 198, 54, 172, 174, 22, 215, 177, 103, 9, 53, 7, 237, 216, 26, 61, 64, 214, 107, 236, 97, 24, 82, 52, 152, 143, 134, 55, 32, 193, 100, 150, 177, 69, 153, 141, 196, 239, 196, 212, 251, 232, 229, 36, 116, 164, 125, 31, 226, 125, 183, 138, 115, 227, 26, 78, 238, 78, 35, 46, 51, 169, 242, 226, 0, 156, 11, 33, 207, 41, 173, 58, 154, 62, 210, 81, 203, 84, 27, 115, 62, 11, 21, 183, 249, 24, 133, 241, 39, 164, 227, 166, 197, 195, 73, 0, 99, 167, 138, 132, 154, 118, 4, 93, 21, 240, 255, 110, 83, 244, 195, 158, 6, 25, 23, 81, 196, 103, 17, 27, 125, 213, 220, 93, 174, 13, 90, 19, 141, 7, 82, 109, 94, 118, 192, 8, 92, 28, 244, 135, 113, 209, 70, 199, 218, 20, 70, 113, 24, 131, 155, 141, 22, 55, 69, 13, 63, 215, 179, 172, 150, 235, 135, 123, 227, 146, 244, 76, 172, 31, 170, 71, 110, 94, 185, 255, 17, 244, 50, 33, 246, 168, 252, 107, 206, 224, 22, 185, 172, 221, 77, 22, 24, 14, 74, 136, 161, 156, 21, 50, 147, 227, 159, 2, 159, 68, 187, 210, 226, 42, 134, 126, 160, 198, 146, 220, 220, 148, 107, 71, 207, 172, 159, 216, 136, 242, 28, 194, 126, 157, 63, 225, 103, 187, 66, 63, 213, 10, 205, 51, 79, 77, 170, 252, 176, 251, 231, 229, 5, 163, 163, 131, 140, 70, 162, 90, 73, 187, 43, 99, 156, 101, 82, 30, 149, 129, 177, 108, 242, 165, 224, 152, 52, 181, 113, 131, 223, 142, 124, 141, 107, 171, 161, 106, 199, 50, 74, 241, 186, 10, 101, 242, 27, 250, 73, 79, 239, 216, 192, 130, 135, 81, 114, 102, 180, 163, 212, 238, 135, 71, 223, 219, 225, 79, 31, 122, 185, 109, 254, 249, 205, 90, 118, 122, 243, 41, 34, 28, 227, 248, 16, 201, 187, 182, 168, 10, 68, 47, 64, 79, 110, 20, 44, 206, 2, 152, 248, 121, 208, 51, 84, 182, 58, 210, 26, 246, 14, 97, 97, 131, 222, 99, 203, 9, 243, 246, 136, 236, 227, 235, 173, 216, 164, 55, 237, 181, 144, 59, 191, 58, 102, 41, 37, 137, 127, 124, 111, 252, 34, 84, 158, 83, 140, 128, 30, 96, 220, 195, 65, 85, 42, 4, 234, 41, 17, 168, 191, 179, 72, 67, 184, 196, 0, 123, 27, 95, 146, 15, 236, 66, 208, 20, 51, 35, 11, 8, 171, 103, 1, 181, 221, 168, 42, 216, 137, 173, 74, 54, 75, 173, 128, 205, 222, 14, 28, 213, 36, 163, 168, 17, 14, 210, 55, 29, 81, 153, 30, 28, 186, 178, 188, 83, 20, 76, 253, 191, 213, 91, 226, 184, 84, 181, 76, 173, 202, 242, 82, 242, 154, 216, 37, 131, 118, 174, 72, 232, 31, 89, 81, 124, 51, 205, 251, 65, 240, 23, 25, 210, 148, 211, 76, 250, 17, 252, 205, 40, 108, 79, 110, 95, 78, 221, 244, 24, 53, 242, 1, 179, 225, 156, 152, 142, 197, 232, 70, 198, 244, 78, 118, 18, 234, 20, 10, 7, 40, 135, 160, 188, 47, 130, 36, 17, 5, 158, 46, 33, 66, 38, 144, 31, 251, 137, 219, 76, 188, 191, 236, 13, 0, 17, 79, 139, 121, 15, 59, 58, 180, 101, 252, 183, 59, 231, 245, 120, 138, 20, 149, 133, 192, 74, 122, 237, 91, 102, 114, 71, 121, 12, 117, 209, 182, 173, 211, 126, 35, 95, 114, 75, 16, 154, 192, 115, 193, 105, 121, 39, 18, 133, 6, 8, 36, 68, 124, 147, 98, 174, 108, 8, 157, 204, 127, 145, 204, 251, 190, 0, 90, 53, 140, 86, 23, 94, 109, 30, 235, 49, 168, 130, 51, 87, 146, 55, 110, 14, 120, 173, 223, 113, 99, 157, 196, 48, 155, 156, 148, 237, 47, 90, 69, 175, 235, 211, 191, 230, 90, 50, 56, 222, 151, 134, 167, 116, 136, 210, 147, 152, 160, 158, 5, 45, 107, 122, 232, 216, 227, 106, 21, 10, 109, 216, 40, 212, 49, 96, 170, 78, 57, 213, 172, 112, 161, 49, 222, 93, 104, 247, 58, 56, 136, 217, 80, 223, 13, 51, 222, 192, 234, 90, 10, 159, 5, 91, 172, 41, 191, 66, 182, 33, 67, 209, 129, 224, 214, 55, 170, 154, 95, 20, 107, 192, 245, 249, 164, 31, 133, 151, 147, 129, 39, 146, 49, 14, 173, 143, 183, 140, 169, 164, 17, 97, 113, 107, 9, 18, 193, 189, 27, 167, 106, 32, 54, 113, 146, 57, 99, 49, 227, 204, 36, 91, 106, 210, 4, 72, 204, 53, 114, 69, 72, 232, 132, 77, 109, 81, 182, 14, 104, 48, 19, 105, 182, 189, 107, 242, 12, 224, 199, 14, 193, 185, 63, 0, 107, 203, 48, 236, 171, 43, 123, 115, 208, 122, 7, 197, 73, 149, 155, 90, 150, 149, 66, 236, 169, 149, 140, 39, 77, 218, 91, 73, 16, 56, 10, 185, 21, 173, 175, 10, 167, 224, 185, 18, 29, 216, 240, 237, 18, 186, 222, 28, 182, 123, 142, 217, 114, 124, 180, 116, 220, 186, 190, 127, 180, 109, 107, 151, 186, 29, 47, 147, 5, 249, 155, 128, 21, 203, 64, 60, 26, 199, 210, 3, 245, 78, 30, 20, 37, 220, 182, 200, 54, 149, 250, 81, 166, 32, 137, 243, 212, 63, 248, 180, 76, 59, 247, 130, 217, 8, 107, 242, 144, 91, 91, 78, 222, 148, 229, 255, 177, 109, 201, 186, 153, 163, 147, 138, 219, 142, 160, 84, 81, 145, 231, 140, 3, 222, 57, 9, 121, 111, 243, 87, 250, 108, 133, 211, 49, 249, 137, 177, 112, 191, 35, 65, 142, 189, 0, 69, 218, 245, 131, 172, 12, 225, 250, 210, 204, 176, 244, 148, 233, 111, 158, 227, 169, 224, 4, 23, 116, 45, 251, 209, 118, 25, 85, 112, 129, 169, 151, 222, 178, 65, 183, 19, 117, 97, 111, 81, 153, 195, 81, 14, 1, 117, 117, 224, 24, 240, 142, 55, 32, 98, 70, 185, 81, 203, 179, 192, 130, 254, 121, 231, 44, 102, 93, 10, 44, 98, 103, 166, 251, 89, 35, 14, 191, 164, 187, 204, 174, 236, 22, 199, 157, 212, 96, 59, 182, 135, 17, 13, 68, 128, 11, 125, 121, 156, 102, 38, 252, 215, 20, 76, 94, 4, 141, 149, 252, 196, 71, 115, 143, 86, 182, 98, 104, 15, 213, 183, 164, 62, 180, 28, 84, 240, 191, 80, 173, 65, 194, 90, 117, 236, 226, 17, 134, 192, 51, 99, 200, 245, 75, 204, 32, 20, 228, 6, 60, 180, 228, 115, 204, 201, 212, 161, 100, 17, 144, 46, 181, 45, 22, 122, 131, 237, 34, 224, 24, 102, 166, 254, 216, 19, 39, 178, 157, 218, 34, 132, 31, 204, 36, 214, 152, 250, 253, 98, 216, 177, 102, 242, 156, 102, 111, 78, 94, 111, 68, 93, 131, 159, 62, 136, 243, 56, 196, 164, 26, 11, 123, 152, 195, 189, 37, 167, 151, 69, 99, 142, 38, 150, 87, 202, 235, 196, 249, 148, 16, 224, 6, 14, 80, 209, 196, 178, 129, 255, 10, 26, 183, 112, 6, 24, 52, 105, 199, 179, 127, 153, 12, 247, 241, 75, 18, 126, 243, 160, 234, 136, 125, 45, 92, 207, 60, 30, 223, 73, 42, 114, 7, 113, 16, 38, 211, 25, 220, 93, 15, 86, 58, 10, 218, 73, 128, 129, 122, 125, 21, 65, 137, 29, 131, 116, 143, 69, 237, 254, 138, 81, 95, 51, 229, 64, 82, 223, 179, 73, 163, 87, 10, 30, 137, 157, 197, 22, 94, 233, 190, 125, 179, 76, 57, 177, 52, 136, 121, 68, 0, 206, 252, 212, 250, 4, 45, 222, 95, 254, 55, 228, 210, 129, 56, 69, 241, 161, 50, 231, 96, 81, 217, 94, 177, 13, 8, 161, 90, 142, 254, 72, 106, 62, 158, 221, 209, 28, 192, 65, 71, 64, 57, 107, 233, 143, 173, 118, 123, 240, 100, 11, 130, 44, 227, 225, 97, 119, 31, 131, 233}
	secret := "2gr!4Yu$JW7pyMfXJXLQcdGcP7JZ7G8*&e+@w%!*TzNBZRX2jX"

	_, err := BuildInfoDecrypt(build_info_arr, secret)
	if err != nil {
		t.Errorf("%s", "unable to process decryption")
		t.FailNow()
	}
}

func TestBuildInfoCrypt(t *testing.T) {
	build_info_str_before := `{"ro.product.manufacturer":"HUAWEI","gsm.sim.operator.alpha":",","ro.debuggable":"0","persist.sys.usb.config":"mtp,adb","init.svc.netmgrd":"running","init.svc.debuggerd":"running","persist.radio.eons.enabled":"false","persist.sys.profiler_ms":"0","init.svc.ueventd":"running","persist.radio.custom_ecc":"1","ro.product.model":"H30-C00","ro.boot.emmc":"true","ro.build.fingerprint":"Huawei/H30-C00/hwH30-C00:4.3/HuaweiH30-C00/C92B184:user/ota-rel-keys,release-keys","service.bootanim.exit":"1","ro.build.product":"H30-C00","init.svc.irsc_util":"stopped","ro.bootloader":"unknown","init.svc.vold":"running",".libc.so.e_machine":"false","init.svc.mpdecision":"running","ro.boot.serialno":"8239868a","sys.settings_global_version":"6","net.hostname":"android-997d50646e34835a","keyguard.no_require_sim":"true","init.svc.p2p_supplicant":"running","ro.build.version.sdk":"18","net.bt.name":"Android","telephony.lteOnCdmaDevice":"0","sys.usb.config":"mtp,adb","init.svc.time_daemon":"running","ro.bootmode":"unknown","ro.baseband":"msm","ro.runtime.firstboot":"1464317954203","ro.build.host":"huawei-desktop","init.svc.thermal-engine":"running","ro.build.display.id":"H30-C00V100R001C92B184","ril.ecclist":"911,112,000,08,110,999,118,119,120,122","persist.service.bdroid.bdaddr":"22:22:be:94:5f:ef","persist.radio.data_no_toggle":"1","ro.revision":"0","wifi.interface":"wlan0","gsm.operator.isroaming":"false,false","persist.sys.timezone":"Asia/Shanghai","gsm.operator.numeric":"null,null","ro.telephony.default_network":"4","ro.allow.mock.location":"0","ro.crypto.state":"unsupported","ro.boot.baseband":"msm","dalvik.vm.heapstartsize":"5m","gsm.version.baseband":"203015,203015","dalvik.vm.heapminfree":"2m","ro.product.brand":"Huawei","gsm.sim.operator.numeric":",","ro.config.notification_sound":"notification.ogg","ro.build.date.utc":"1416427365","ro.board.platform":"msm8610","dalvik.vm.heaptargetutilization":"0.75","ro.product.device":"hwH30-C00","ro.ril.svdo":"false","dev.bootcomplete":"1","gsm.sim.state":"ABSENT,ABSENT",".Debug.isDebuggerConnected":"false","init.svc.keystore":"running","ro.hardware":"qcom","init.svc.netd":"running","ro.build.characteristics":"default","ro.build.id":"HuaweiH30-C00","init.svc.qmuxd":"running","init.svc.qcamerasvr":"running","sys.usb.state":"mtp,adb","ro.adb.secure":"1","rild.libpath":"/vendor/lib/libril-qc-qmi-1.so","sys.boot_completed":"1","ro.product.name":"H30-C00","net.change":"net.dns3","ro.config.alarm_alert":"alarm.ogg","ro.build.tags":"release-keys","gsm.version.ril-impl":"Qualcomm RIL 1.0","ro.product.board":"H30-C00","init.svc.drm":"running","ro.build.description":"H30-C00-user 4.3 GRJ90 C92B184 release-keys","init.svc.media":"running","ro.build.version.codename":"REL","ro.product.cpu.abi":"armeabi-v7a","dalvik.vm.heapgrowthlimit":"96m","ro.sf.lcd_density":"320","init.svc.bootanim":"stopped","dalvik.vm.heapsize":"256m","dalvik.vm.stack-trace-file":"/data/anr/traces.txt","ro.com.google.clientidbase":"android-huawei","init.svc.surfaceflinger":"running","ro.serialno":"f49ff391c6c0","dalvik.vm.heapmaxfree":"8m","ro.build.date":"Thu Nov 20 04:02:45 CST 2014","ro.com.android.dataroaming":"false","init.svc.flash_recovery":"stopped","ro.build.version.release":"4.3","vold.post_fs_data_done":"1","wlan.driver.status":"ok","ro.product.cpu.abi2":"armeabi","drm.service.enabled":"true","media.aac_51_output_enabled":"true","init.svc.zygote":"running","ro.telephony.call_ring.multiple":"false","init.svc.servicemanager":"running","gsm.current.phone-type":"1,1","ro.build.user":"huawei","ro.opengles.version":"196608","gsm.sim.operator.iso-country":",","ro.config.ringtone":"ringtone.ogg","ro.boot.hardware":"qcom","ro.ril.svlte1x":"false","init.svc.installd":"running","init.svc.qseecomd":"running","ro.secure":"1","ro.carrier":"unknown","ro.build.type":"user","ro.build.version.incremental":"C92B184","init.svc.adbd":"running","net.qtaguid_enabled":"1","net.dns3":"114.114.115.115","gsm.operator.alpha":"null,null","gsm.network.type":"Unknown,Unknown","net.dns2":"114.114.114.114","net.dns1":"202.106.196.115","init.svc.rmt_storage":"running","init.svc.ril-daemon":"running"}`
	secret := "2gr!4Yu$JW7pyMfXJXLQcdGcP7JZ7G8*&e+@w%!*TzNBZRX2jX"

	build_info_arr, err := BuildInfoEncrypt(build_info_str_before, secret)
	if err != nil {
		t.Errorf("%s", "unable to process encryption")
		t.FailNow()
	}

	time.Sleep(time.Second * 2)

	build_info_str_after, err := BuildInfoDecrypt(build_info_arr, secret)

	if err != nil {
		t.Errorf("%s", "unable to process decryption")
		t.FailNow()
	}

	if build_info_str_before != build_info_str_after {
		t.FailNow()
	}
}
